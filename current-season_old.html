<!doctype html>
<html lang="en" data-root=".">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Current Season ‚Äî Season 5</title>
  <link rel="stylesheet" href="styles.css">

  <style>
    .muted{opacity:.78}
    .ai-controls{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;margin:14px 0}
    .ai-field{flex:1;min-width:240px}
    .ai-field label{display:block;margin-bottom:6px}
    .ai-field input,.ai-field textarea{
      width:100%;
      border-radius:12px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:inherit;
      outline:none;
    }
    .ai-field textarea{resize:vertical}
    .ai-actions{display:flex;gap:10px;flex-wrap:wrap}
    .ai-inline{display:flex;gap:12px;flex-wrap:wrap}
    .ai-list{display:flex;flex-direction:column;gap:12px;margin-top:8px}
    .ai-row{padding:10px 10px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.12)}
    .ai-row-top{display:flex;justify-content:space-between;gap:10px;align-items:baseline}
    .ai-row-label{font-weight:700}
    .ai-row-val{opacity:.85;font-variant-numeric:tabular-nums}
    .ai-row-sub{margin-top:6px;opacity:.78;font-size:.92rem}
    .ai-bar{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;margin-top:8px}
    .ai-bar span{display:block;height:100%;background:rgba(150,100,255,.85)}
    .ai-tag{display:inline-block;margin-left:8px;font-size:.8rem;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.08);opacity:.85}
    .ai-line{padding:6px 2px}
  
    /* AI: avatars + cast grid */
    .ai-player{display:flex;align-items:center;gap:10px;min-width:0}
    .ai-avatar{width:28px;height:28px;border-radius:999px;overflow:hidden;flex:0 0 28px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);
      display:grid;place-items:center}
    .ai-avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .ai-avatar span{font-size:16px;opacity:.9;line-height:1}
    .ai-name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ai-out{opacity:.45;filter:grayscale(1)}
    .ai-cast-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
      gap:12px;
      margin-top:10px
    }
    .ai-cast-card{
      display:flex;gap:12px;align-items:center;
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.12);
      text-decoration:none;color:inherit
    }
    .ai-cast-card:hover{border-color:rgba(255,255,255,.16);background:rgba(0,0,0,.16)}
    .ai-cast-left{display:flex;align-items:center;gap:10px;min-width:0}
    .ai-cast-avatar{width:42px;height:42px;border-radius:999px;overflow:hidden;flex:0 0 42px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);
      display:grid;place-items:center}
    .ai-cast-avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .ai-cast-avatar span{font-size:20px;opacity:.9}
    .ai-cast-meta{min-width:0}
    .ai-cast-meta .t1{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ai-cast-meta .t2{opacity:.72;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  </style>

</head>
<body>
<!-- SITE HEADER START -->
<header class="modern-header" id="modernHeader">
  <div class="header-container">
    <!-- Top Bar -->
    <div class="header-top">
      <a href="index.html" class="brand-section" aria-label="Go to home">
        <div class="brand-icon">
          <span class="brand-logo-text">‚ö°</span>
        </div>
        <div class="brand-content">
          <h1>DC <span class="brand-gradient">Franchise</span> Database</h1>
          <p class="brand-subtitle">Season <span id="currentSeasonNum">5</span> Live ‚Ä¢ Click to Explore</p>
        </div>
      </a>

      <div class="stats-badge">
        <div class="stats-main"><span id="totalSeasons">5</span> Seasons ‚Ä¢ <span id="totalPlayers">58</span> Players</div>
        <div class="stats-sub">Icons: <span id="iconFormat">name.png</span></div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="header-nav" aria-label="Primary navigation">
      <ul class="nav-list">
        <li class="nav-item">
          <a href="index.html" class="nav-link" data-page="index">
            <span class="nav-icon">üè†</span>
            <span>Home</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="current-season.html" class="nav-link" data-page="current-season">
            <span class="nav-icon">üìä</span>
            <span>Current Season</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="voting-analytics.html" class="nav-link" data-page="voting-analytics">
            <span class="nav-icon">üßæ</span>
            <span>Voting Analytics</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="franchise.html" class="nav-link" data-page="franchise">
            <span class="nav-icon">üèõÔ∏è</span>
            <span>Franchise</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="rankings.html" class="nav-link" data-page="rankings">
            <span class="nav-icon">üèÜ</span>
            <span>Rankings</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="seasons.html" class="nav-link" data-page="seasons">
            <span class="nav-icon">üóÇÔ∏è</span>
            <span>Seasons</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="devotees.html" class="nav-link" data-page="devotees">
            <span class="nav-icon">üë•</span>
            <span>Players</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="awards.html" class="nav-link" data-page="awards">
            <span class="nav-icon">üèÖ</span>
            <span>Awards</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</header>

<script>
(function() {
  // Load site config and update header stats
  if (window.SITE_CONFIG) {
    document.getElementById('totalSeasons').textContent = window.SITE_CONFIG.seasons;
    document.getElementById('totalPlayers').textContent = window.SITE_CONFIG.players;
    document.getElementById('currentSeasonNum').textContent = window.SITE_CONFIG.currentSeason;
    document.getElementById('iconFormat').textContent = window.SITE_CONFIG.iconFormat;
  }

  // Scroll behavior
  const header = document.getElementById('modernHeader');
  if (!header) return;
  
  window.addEventListener('scroll', () => {
    const currentScroll = window.pageYOffset;
    if (currentScroll > 20) {
      header.classList.add('scrolled');
    } else {
      header.classList.remove('scrolled');
    }
  }, { passive: true });

  // Active page highlighting
  const currentPage = window.location.pathname.split('/').pop() || 'index.html';
  const navLinks = document.querySelectorAll('.nav-link');
  
  navLinks.forEach(link => {
    const linkPage = link.getAttribute('href');
    if (linkPage === currentPage || (currentPage === '' && linkPage === 'index.html')) {
      link.classList.add('active');
    }
  });

  // Path resolution for nested folders
  const root = (document.documentElement.dataset.root || document.body.dataset.root || ".").replace(/\/+$/, "");
  
  if (root !== ".") {
    const allLinks = header.querySelectorAll('a[href]');
    allLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (href && !href.startsWith('http') && !href.startsWith('#')) {
        link.setAttribute('href', root + '/' + href);
      }
    });
  }
})();
</script>
<!-- SITE HEADER END -->

  <div class="container">
  <div class="hero">
    <h1>üìä Season 5: Rescue Island</h1>
    <p>Current Season Analytics ‚Ä¢ Winner: Mickey</p>
  </div>

  <div class="callout">
    <b>CURRENT SEASON:</b> Season 5: Rescue Island (18 players, 14 episodes) |
    <b>WINNER:</b> <a href="player.html?player=mickey">Mickey</a> (3-3-2 tie ‚Üí tiebreak) |
    <b>FAN FAVORITE:</b> <a href="player.html?player=ryan">Ryan</a>
  </div>

  <div class="section-title">
    <h2>Season Overview</h2>
  </div>

  <div class="kpi-grid">
    <div class="kpi">
      <h3>Season Details</h3>
      <ul>
        <li><b>Season:</b> 5 (Total Drama: Rescue Island)</li>
        <li><b>Cast:</b> 18 players</li>
        <li><b>Format:</b> 3 tribes (Belo / Lulu / Reba)</li>
        <li><b>Key twists:</b> tribe re-draw (Ep 4) ‚Ä¢ earn-the-merge split (Ep 6) ‚Ä¢ split tribal (Ep 7) ‚Ä¢ auction lose-a-vote (Ep 8) ‚Ä¢ journey vote-loss (Ep 9) ‚Ä¢ final 4 fire-making</li>
      </ul>
    </div>

    <div class="kpi">
      <h3>Final 3</h3>
      <ul>
        <li><b>Winner:</b> <a href="player.html?player=mickey">Mickey</a></li>
        <li><b>Runner-Up:</b> <a href="player.html?player=sky">Sky</a></li>
        <li><b>Third Place:</b> <a href="player.html?player=ryan">Ryan</a></li>
        <li><b>FTC:</b> 3‚Äì3‚Äì2 tie ‚Üí Ryan breaks tie for Mickey</li>
      </ul>
    </div>

    <div class="kpi">
      <h3>Key Players</h3>
      <ul>
        <li><b>Fan Favorite:</b> <a href="player.html?player=ryan">Ryan</a></li>
        <li><b>Challenge Beast:</b> <a href="player.html?player=sky">Sky</a> (4 total wins, 3 immunities)</li>
        <li><b>Strategic #1:</b> <a href="player.html?player=scarlett">Scarlett</a> (best strategic ranking)</li>
        <li><b>Quiet Threat:</b> <a href="player.html?player=mickey">Mickey</a> (0 votes against all season)</li>
      </ul>
    </div>

    <div class="kpi">
      <h3>Signature Moves</h3>
      <ul>
        <li><b>KIP Theft:</b> <a href="player.html?player=rodney">Rodney</a> steals <a href="player.html?player=josee">Josee</a>'s idol (Earn-the-Merge chaos)</li>
        <li><b>Safety Without Power:</b> <a href="player.html?player=max">Max</a> leaves Tribal, forces a redirect boot</li>
        <li><b>Idol patience:</b> <a href="player.html?player=sky">Sky</a>'s F6 idol play flips the endgame</li>
        <li><b>Fire-making:</b> <a href="player.html?player=ryan">Ryan</a> wins the duel and becomes kingmaker</li>
      </ul>
    </div>
  </div>

  <div class="section-title">
    <h2>Episode Progression</h2>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Episode</th>
        <th>Eliminated</th>
        <th>Vote</th>
        <th>Key Events</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>1</td>
        <td><a href="player.html?player=leonard"><b>Leonard</b></a></td>
        <td>5-2</td>
        <td>Opening ‚Äúkeep tribe strong‚Äù boot ‚Ä¢ Shawn casts a secret vote at Tribal</td>
      </tr>
      <tr>
        <td>2</td>
        <td><a href="player.html?player=ella"><b>Ella</b></a></td>
        <td>2-1</td>
        <td>Vote-loss chaos: Blaineley sacrifices her vote, Ella plays SITD (Not Safe)</td>
      </tr>
      <tr>
        <td>3</td>
        <td><a href="player.html?player=beardo"><b>Beardo</b></a></td>
        <td>1-0 (effective)</td>
        <td>Blaineley plays idol + Inheritance ‚Ä¢ Beardo SITD removes his vote</td>
      </tr>
      <tr>
        <td>4</td>
        <td><a href="player.html?player=samey"><b>Samey</b></a></td>
        <td>4‚òÖ-1</td>
        <td><b>Random tribe re-draw</b> into new 3 tribes ‚Ä¢ idol negation chaos</td>
      </tr>
      <tr>
        <td>5</td>
        <td><a href="player.html?player=jasmine"><b>Jasmine</b></a></td>
        <td>2-1</td>
        <td>Simple numbers vote ‚Ä¢ tribe performance politics</td>
      </tr>
      <tr>
        <td>6</td>
        <td><a href="player.html?player=josee"><b>Josee</b></a></td>
        <td>6‚òÖ-5</td>
        <td><b>Earn the Merge</b> split teams ‚Ä¢ Rodney uses KIP to steal Josee‚Äôs idol</td>
      </tr>
      <tr>
        <td>7</td>
        <td><a href="player.html?player=rodney"><b>Rodney</b></a> / <a href="player.html?player=topher"><b>Topher</b></a></td>
        <td>3-1 / 5-1</td>
        <td><b>Split Tribal (two boots)</b> ‚Ä¢ Max uses Safety Without Power ‚Ä¢ Topher becomes 1st juror</td>
      </tr>
      <tr>
        <td>8</td>
        <td><a href="player.html?player=max"><b>Max</b></a></td>
        <td>5-3</td>
        <td>Auction twist (lose a vote) ‚Ä¢ Mickey finds an idol</td>
      </tr>
      <tr>
        <td>9</td>
        <td><a href="player.html?player=shawn"><b>Shawn</b></a></td>
        <td>5-2</td>
        <td>Journey vote-loss round ‚Ä¢ endgame lines harden</td>
      </tr>
      <tr>
        <td>10</td>
        <td><a href="player.html?player=blaineley"><b>Blaineley</b></a></td>
        <td>3-2-1</td>
        <td>Advantage-heavy player finally cut ‚Ä¢ chaotic multi-target vote</td>
      </tr>
      <tr>
        <td>11</td>
        <td><a href="player.html?player=amy"><b>Amy</b></a></td>
        <td>2-2-1</td>
        <td>Tight split ‚Ä¢ twin storyline ends in jury</td>
      </tr>
      <tr>
        <td>12</td>
        <td><a href="player.html?player=dave"><b>Dave</b></a></td>
        <td>3-3‚òÖ</td>
        <td>Sky‚Äôs idol play flips the consensus plan ‚Ä¢ Dave becomes the pivot boot</td>
      </tr>
      <tr>
        <td>13</td>
        <td><a href="player.html?player=sugar"><b>Sugar</b></a></td>
        <td>4-1</td>
        <td>Most-targeted survivor finally falls ‚Ä¢ clears the lane for the finale trio</td>
      </tr>
      <tr>
        <td>14 (Finale)</td>
        <td><a href="player.html?player=scarlett"><b>Scarlett</b></a></td>
        <td>Fire-making</td>
        <td>Ryan wins fire-making ‚Ä¢ Final Tribal: 3-3-2 tie, Ryan votes Mickey to win</td>
      </tr>
      <tr class="highlight">
        <td colspan="4"><b>Final Tribal Council:</b> Mickey 3, Sky 3, Ryan 2 ‚Üí <b>tiebreak:</b> Ryan votes Mickey (Mickey wins üëë)</td>
      </tr>
    </tbody>
  </table>

  <div class="section-title">
    <h2>Challenge Statistics</h2>
  </div>

  <div class="kpi-grid">
    <div class="kpi">
      <h3>Individual Immunity</h3>
      <ul>
        <li><b>Sky:</b> 3 wins</li>
        <li><b>Mickey:</b> 2 wins</li>
        <li><b>Scarlett:</b> 2 wins</li>
        <li><b>Dave:</b> 1 win</li>
        <li><b>Ryan:</b> 1 win</li>
      </ul>
    </div>

    <div class="kpi">
      <h3>Total Challenge Wins</h3>
      <ul>
        <li><b>Sky:</b> 4</li>
        <li><b>Dave:</b> 2</li>
        <li><b>Mickey:</b> 2</li>
        <li><b>Scarlett:</b> 2</li>
        <li><b>Ryan:</b> 1</li>
      </ul>
    </div>

    <div class="kpi">
      <h3>Voting Records</h3>
      <ul>
        <li><b>Most Votes Against:</b> Sugar (10)</li>
        <li><b>Next Most Targeted:</b> Rodney (9), Blaineley (8), Ryan (7)</li>
        <li><b>Zero Votes Against:</b> Mickey (0)</li>
      </ul>
    </div>

    <div class="kpi">
      <h3>Idols & Advantages</h3>
      <ul>
        <li><b>Idols found:</b> Sky (2), Shawn (1), Josee (1), Blaineley (1), Mickey (1)</li>
        <li><b>Biggest advantage:</b> Rodney‚Äôs Knowledge Is Power steal</li>
        <li><b>Other powers:</b> Max (Safety Without Power), Blaineley (Inheritance), Mickey (Goodwill)</li>
      </ul>
    </div>
  </div>

  <div class="section-title">
    <h2>Season Records & Milestones</h2>
  </div>

  <div class="panel">
    <h3>üèÜ Franchise Notes (Season 5)</h3>
    <ul>
      <li><b>Closest Finale (tie):</b> 3-3-2 ‚Üí tiebreak winner vote</li>
      <li><b>Winner with 0 votes against:</b> Mickey (elite threat management)</li>
      <li><b>Most targeted player:</b> Sugar (10 votes) still reached Final 5</li>
      <li><b>Biggest swing round:</b> Earn-the-Merge idol theft + chaos vote</li>
      <li><b>Fire-making kingmaker:</b> Ryan (wins duel + decides winner)</li>
    </ul>
  </div>

  <div class="section-title">
    <h2>Jury Vote Breakdown</h2>
  </div>

  <div class="panel">
    <table class="table">
      <thead>
        <tr>
          <th>Juror</th>
          <th>Vote</th>
        </tr>
      </thead>
      <tbody>
        <tr><td><a href="player.html?player=topher"><b>Topher</b></a></td><td>Mickey</td></tr>
        <tr><td><a href="player.html?player=sugar"><b>Sugar</b></a></td><td>Sky</td></tr>
        <tr><td><a href="player.html?player=shawn"><b>Shawn</b></a></td><td>Mickey</td></tr>
        <tr><td><a href="player.html?player=scarlett"><b>Scarlett</b></a></td><td>Ryan</td></tr>
        <tr><td><a href="player.html?player=max"><b>Max</b></a></td><td>Sky</td></tr>
        <tr><td><a href="player.html?player=dave"><b>Dave</b></a></td><td>Mickey</td></tr>
        <tr><td><a href="player.html?player=blaineley"><b>Blaineley</b></a></td><td>Sky</td></tr>
        <tr><td><a href="player.html?player=amy"><b>Amy</b></a></td><td>Ryan</td></tr>
      </tbody>
    </table>
    <div class="callout" style="margin-top:12px;">
      <b>Tally (before tiebreak):</b> Mickey 3 ‚Ä¢ Sky 3 ‚Ä¢ Ryan 2 ‚Üí <b>Tiebreak:</b> Ryan votes Mickey
    </div>
  </div>

  
  <div class="section-title">
    <h2>üìà Cullhouse Analytics (AI)</h2>
  </div>

  <div class="panel" id="aiPanel">
    <p class="muted" style="margin-top:0;">
      Paste your episode summary (like your Episode 1 write-up) and click <b>Generate Analytics</b>.
      This will create narrative + inferred stats (power rankings, boot odds, alliance stability) without changing your canonical season facts.
    </p>

    <div class="ai-controls">
      <div class="ai-field">
        <label for="aiWorkerUrl"><b>AI Endpoint (Cloudflare Worker URL)</b></label>
        <input id="aiWorkerUrl" type="url" placeholder="https://dc-analytics.YOURSUBDOMAIN.workers.dev" />
      </div>
      <div class="ai-actions">
        <button class="btn" id="aiSaveUrl" type="button">Save URL</button>
      </div>
    </div>

    <div class="ai-controls">
      <div class="ai-inline">
        <div class="ai-field">
          <label for="aiSeason"><b>Season</b></label>
          <input id="aiSeason" type="number" min="1" value="5" />
        </div>
        <div class="ai-field">
          <label for="aiEpisode"><b>Episode</b></label>
          <input id="aiEpisode" type="number" min="1" value="1" />
        </div>
      </div>
      <div class="ai-actions">
        <button class="btn" id="aiGenerate" type="button">Generate Analytics</button>
        <button class="btn" id="aiLoadCache" type="button">Load Cached</button>
      </div>
    </div>

    <div class="ai-field">
      <label for="aiSummaryText"><b>Episode Summary Input</b></label>
      <textarea id="aiSummaryText" rows="10" placeholder="Paste your episode summary here..."></textarea>
      <div class="muted" id="aiStatus" style="margin-top:8px;"></div>
      <details id="aiRawDetails" style="display:none; margin-top:10px;">
        <summary class="muted">Debug: raw AI response</summary>
        <pre id="aiRaw" style="white-space:pre-wrap; font-size:12px; margin-top:8px;"></pre>
      </details>

    </div>
  </div>

  <div class="kpi-grid" id="aiTopGrid" style="display:none;">
    <div class="kpi">
      <h3>Best Move</h3>
      <ul>
        <li id="aiBestMove"><b>‚Äî</b></li>
      </ul>
    </div>
    <div class="kpi">
      <h3>Biggest Risk</h3>
      <ul>
        <li id="aiBiggestRisk"><b>‚Äî</b></li>
      </ul>
    </div>
    <div class="kpi">
      <h3>Episode Summary</h3>
      <ul>
        <li id="aiNarrative"><b>‚Äî</b></li>
      </ul>
    </div>
    <div class="kpi">
      <h3>Quick Notes</h3>
      <ul>
        <li id="aiQuickNote"><b>Generated</b> insights are inferred from your summary; update your summary and re-run any time.</li>
      </ul>
    </div>
  </div>

  <div class="kpi-grid" id="aiMidGrid" style="display:none;">
    <div class="kpi">
      <h3>Boot Odds (Next)</h3>
      <div id="aiBootOdds" class="ai-list"></div>
    </div>
    <div class="kpi">
      <h3>Power Rankings</h3>
      <div id="aiPowerRankings" class="ai-list"></div>
    </div>
    <div class="kpi">
      <h3>Alliance Stability</h3>
      <div id="aiAllianceStability" class="ai-list"></div>
    </div>
    <div class="kpi">
      <h3>Titles</h3>
      <div id="aiTitles" class="ai-list"></div>
    </div>
  
  <div class="kpi-grid" id="aiCastGridWrap" style="display:none; margin-top:14px;">
    <div class="kpi" style="grid-column:1/-1;">
      <h3>üë• Current Players</h3>
      <div class="muted" style="margin-top:-6px;">Uses players mentioned in your AI output (Titles / Power Rankings / Boot Odds). Greyed-out = eliminated detected in your pasted summary.</div>
      <div class="ai-cast-grid" id="aiCastGrid"></div>
    </div>
  </div>

</div>

  <script>
  (function() {
    const $ = (id) => document.getElementById(id);

    const statusEl = $('aiStatus');
    const workerUrlEl = $('aiWorkerUrl');
    const seasonEl = $('aiSeason');
    const episodeEl = $('aiEpisode');
    const summaryEl = $('aiSummaryText');

    const topGrid = $('aiTopGrid');
    const midGrid = $('aiMidGrid');

    function setStatus(msg) {
      if (statusEl) statusEl.textContent = msg || '';
    }

    function slugify(name) {
      return String(name || '')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '');
    }

    function cacheKey(season, episode) {
      return `AI_ANALYTICS_s${season}_e${episode}`;
    }

    function getWorkerUrl() {
      return normalizeWorkerUrl(workerUrlEl?.value || localStorage.getItem('AI_WORKER_URL') || '');
    }

    function saveWorkerUrl(url) {
      localStorage.setItem('AI_WORKER_URL', url);
    }


    function normalizeWorkerUrl(raw) {
      let url = (raw || '').trim();
      if (!url) return '';
      if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
      return url.replace(/\/+$/, ''); // trim trailing /
    }

    function extractAnalytics(payload) {
      if (!payload) return null;
      // Already in expected shape
      if (payload.narrativeSummary && payload.bestMove && payload.biggestRisk) return payload;

      // Common wrappers
      if (payload.data && payload.data.narrativeSummary) return payload.data;

      // Candidates that might contain JSON text
      const candidates = [];
      if (typeof payload.output_text === 'string') candidates.push(payload.output_text);
      if (typeof payload.outputText === 'string') candidates.push(payload.outputText);

      // Responses API: output[].content[] may include text or json
      if (Array.isArray(payload.output)) {
        for (const item of payload.output) {
          const content = item && Array.isArray(item.content) ? item.content : [];
          for (const c of content) {
            if (!c) continue;
            if (c.type === 'output_json' && c.json && c.json.narrativeSummary) return c.json;
            if (c.json && c.json.narrativeSummary) return c.json;
            if (typeof c.text === 'string') candidates.push(c.text);
          }
        }
      }

      // Try parsing JSON text
      for (const t of candidates) {
        try {
          const obj = JSON.parse(t);
          if (obj && obj.narrativeSummary) return obj;
        } catch (_) {}
      }

      return null;
    }

    function showRaw(payload) {
      const rawEl = $('aiRaw');
      const detailsEl = $('aiRawDetails');
      if (!rawEl || !detailsEl) return;
      rawEl.textContent = JSON.stringify(payload, null, 2);
      detailsEl.style.display = '';
      detailsEl.open = true;
    }

    function linkPlayer(name) {
      const id = slugify(name);
      if (!id) return name;
      return `<a href="player.html?player=${id}"><b>${name}</b></a>`;
    }

    function escapeHtml(str) {
      return String(str ?? '').replace(/[&<>"']/g, (c) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    
    function avatarHtml(id, emoji='üë§', cls='ai-avatar') {
      const safeId = String(id || '').trim();
      const src = safeId ? `assets/avatars/${safeId}.png` : '';
      return `
        <span class="${cls}">
          <img alt="${escapeHtml(safeId)}" src="${src}"
               onerror="this.style.display='none'; this.nextElementSibling.style.display='grid';"
               onload="this.style.display='block'; this.nextElementSibling.style.display='none';">
          <span style="display:grid">${escapeHtml(emoji)}</span>
        </span>`;
    }

    function playerLabel(name, tagText='') {
      const id = slugify(name);
      const tag = tagText ? `<span class="ai-tag">${escapeHtml(tagText)}</span>` : '';
      return `
        <span class="ai-player">
          ${avatarHtml(id, 'üë§', 'ai-avatar')}
          <span class="ai-name">${linkPlayer(name)}${tag}</span>
        </span>`;
    }

    function detectEliminatedNames(summaryText) {
      const txt = String(summaryText || '');
      const out = new Set();
      const m1 = txt.match(/\bELIMINATED\b\s*\n\s*([A-Za-z][A-Za-z0-9 _-]*)/i);
      if (m1 && m1[1]) out.add(m1[1].trim());
      return out;
    }

    function buildMentionedPlayers(data) {
      const names = [];
      const push = (n) => { if (n && typeof n === 'string') names.push(n.trim()); };
      (data.bootPredictions || []).forEach(x => push(x.player));
      (data.powerRankings || []).forEach(x => push(x.player));
      (data.titles || []).forEach(x => push(x.player));
      if (data.bestMove && data.bestMove.player) push(data.bestMove.player);
      if (data.biggestRisk && data.biggestRisk.player) push(data.biggestRisk.player);

      const seen = new Set();
      const unique = [];
      for (const n of names) {
        const k = n.toLowerCase();
        if (!k || seen.has(k)) continue;
        seen.add(k);
        unique.push(n);
      }
      return unique;
    }

    function renderCastGrid(data) {
      const wrap = $('aiCastGridWrap');
      const grid = $('aiCastGrid');
      if (!wrap || !grid) return;

      const players = buildMentionedPlayers(data);
      if (!players.length) {
        wrap.style.display = 'none';
        grid.innerHTML = '';
        return;
      }

      const elimNames = detectEliminatedNames(summaryEl?.value || '');
      const elimSet = new Set(Array.from(elimNames).map(n => n.toLowerCase()));

      const getTitle = (name) => {
        const t = Array.isArray(data.titles)
          ? data.titles.find(x => String(x.player||'').toLowerCase() === String(name).toLowerCase())
          : null;
        return t?.title || '';
      };

      grid.innerHTML = players.map(name => {
        const id = slugify(name);
        const isOut = elimSet.has(String(name).toLowerCase());
        const cls = isOut ? 'ai-cast-card ai-out' : 'ai-cast-card';
        const subtitle = getTitle(name) || (isOut ? 'Eliminated' : 'Active');

        return `
          <a class="${cls}" href="player.html?player=${id}">
            <div class="ai-cast-left">
              ${avatarHtml(id, 'üë§', 'ai-cast-avatar')}
              <div class="ai-cast-meta">
                <div class="t1">${escapeHtml(name)}</div>
                <div class="t2">${escapeHtml(subtitle)}</div>
              </div>
            </div>
          </a>
        `;
      }).join('');

      wrap.style.display = '';
    }

function renderBarRow(labelHtml, valueText, pct) {
      const width = Math.max(0, Math.min(100, pct));
      return `
        <div class="ai-row">
          <div class="ai-row-top">
            <div class="ai-row-label">${labelHtml}</div>
            <div class="ai-row-val">${escapeHtml(valueText)}</div>
          </div>
          <div class="ai-bar"><span style="width:${width}%"></span></div>
        </div>
      `;
    }

    function renderAnalytics(data) {
      if (!data || typeof data !== 'object') return;

      // Show grids
      topGrid.style.display = '';
      midGrid.style.display = '';

      // Top cards
      const best = data.bestMove ? `${playerLabel(data.bestMove.player)} ‚Äî ${escapeHtml(data.bestMove.reason)}` : '‚Äî';
      const risk = data.biggestRisk ? `${playerLabel(data.biggestRisk.player)} ‚Äî ${escapeHtml(data.biggestRisk.reason)}` : '‚Äî';
      $('aiBestMove').innerHTML = best;
      $('aiBiggestRisk').innerHTML = risk;
      $('aiNarrative').innerHTML = escapeHtml(data.narrativeSummary || '‚Äî');

      // Boot odds
      const boot = Array.isArray(data.bootPredictions) ? data.bootPredictions.slice() : [];
      boot.sort((a,b) => (b.prob||0) - (a.prob||0));
      $('aiBootOdds').innerHTML = boot.length
        ? boot.map(x => renderBarRow(playerLabel(x.player), `${Math.round((x.prob||0)*100)}%`, (x.prob||0)*100) +
            `<div class="ai-row-sub">${escapeHtml(x.why || '')}</div>`).join('')
        : '<div class="muted">No boot predictions returned.</div>';

      // Power rankings
      const pr = Array.isArray(data.powerRankings) ? data.powerRankings.slice() : [];
      pr.sort((a,b) => (b.score||0) - (a.score||0));
      $('aiPowerRankings').innerHTML = pr.length
        ? pr.map(x => {
            const label = playerLabel(x.player, x.tag || '');
            return renderBarRow(label, `${Math.round(x.score||0)}/100`, (x.score||0)) +
              `<div class="ai-row-sub">${escapeHtml(x.blurb || '')}</div>`;
          }).join('')
        : '<div class="muted">No power rankings returned.</div>';

      // Alliance stability
      const as = Array.isArray(data.allianceStability) ? data.allianceStability.slice() : [];
      as.sort((a,b) => (b.score||0) - (a.score||0));
      $('aiAllianceStability').innerHTML = as.length
        ? as.map(x => renderBarRow(`<b>${escapeHtml(x.name)}</b>`, `${Math.round(x.score||0)}/100`, (x.score||0)) +
            `<div class="ai-row-sub">${escapeHtml(x.note || '')}</div>`).join('')
        : '<div class="muted">No alliances detected (or not provided in summary).</div>';

      // Titles
      const titles = Array.isArray(data.titles) ? data.titles.slice() : [];
      $('aiTitles').innerHTML = titles.length
        ? titles.map(x => `<div class="ai-line">${playerLabel(x.player)} ‚Äî <span class="muted">${escapeHtml(x.title || '')}</span></div>`).join('')
        : '<div class="muted">No titles returned.</div>';

      renderCastGrid(data);
    }

    async function generate() {
      const workerUrl = getWorkerUrl();
      if (!workerUrl) {
        setStatus('Add your Cloudflare Worker URL first (then click Save URL).');
        return;
      }

      const season = Number(seasonEl.value || 0);
      const episode = Number(episodeEl.value || 0);
      const summaryText = summaryEl.value.trim();

      if (!summaryText) {
        setStatus('Paste an episode summary first.');
        return;
      }

      setStatus('Generating analytics‚Ä¶');

      try {
        const res = await fetch(workerUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ season, episode, summaryText }),
        });

        const data = await res.json();
        localStorage.setItem(cacheKey(season, episode), JSON.stringify(data));
        renderAnalytics(data);
        setStatus(`Done. Cached as ${cacheKey(season, episode)}.`);
      } catch (err) {
        console.error(err);
        setStatus('Error calling AI endpoint. Check your Worker URL and that your Worker is deployed.');
      }
    }

    function loadCache() {
      const season = Number(seasonEl.value || 0);
      const episode = Number(episodeEl.value || 0);
      const raw = localStorage.getItem(cacheKey(season, episode));
      if (!raw) {
        setStatus('No cached analytics for this season/episode yet.');
        return;
      }
      try {
        const rawObj = JSON.parse(raw);
        const data = extractAnalytics(rawObj) || rawObj;
        if (!data || !data.narrativeSummary) { showRaw(rawObj); throw new Error('Cached object is not analytics'); }
        renderAnalytics(data);
        setStatus(`Loaded cached analytics (${cacheKey(season, episode)}).`);
      } catch (e) {
        setStatus('Cached analytics is corrupted. Re-generate.');
      }
    }

    // Init URL from storage
    const storedUrl = localStorage.getItem('AI_WORKER_URL');
    if (storedUrl && workerUrlEl) workerUrlEl.value = normalizeWorkerUrl(storedUrl);

    $('aiSaveUrl')?.addEventListener('click', () => {
      const url = normalizeWorkerUrl(workerUrlEl.value || '');
      if (!url) { setStatus('Paste your Worker URL first.'); return; }
      saveWorkerUrl(url);
      setStatus('Saved Worker URL.');
    });

    $('aiGenerate')?.addEventListener('click', generate);
    $('aiLoadCache')?.addEventListener('click', loadCache);
  })();
  </script>

<div class="center" style="margin-top:22px;">
    <a class="btn" href="season5.html">üìÑ Season 5 page</a>
    <a class="btn" href="season5-awards.html">üèÖ Season 5 Awards</a>
    <a class="btn" href="seasons.html">üóÇÔ∏è All Seasons</a>
  </div>
</div>

<footer class="siteFooter">
  <div class="footerInner">
    <div class="footerTitle">DC Franchise Database</div>
    <div class="footerSub">Static archive ‚Ä¢ 5 seasons ‚Ä¢ 58 players ‚Ä¢ Icons: name.png</div>
  </div>
</footer>
<!-- SITE FOOTER END -->
</body>
</html>
