<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Player Profile</title>
  <link rel="stylesheet" href="styles.css">
</head>
<script src="player-story-formatter.js"></script>
<body>
<!-- SITE HEADER START -->
<header class="modern-header" id="modernHeader">
  <div class="header-container">
    <!-- Top Bar -->
    <div class="header-top">
      <a href="index.html" class="brand-section" aria-label="Go to home">
        <div class="brand-icon">
          <span class="brand-logo-text">‚ö°</span>
        </div>
        <div class="brand-content">
          <h1>DC <span class="brand-gradient">Franchise</span> Database</h1>
          <p class="brand-subtitle">Season <span id="currentSeasonNum">5</span> Live ‚Ä¢ Click to Explore</p>
        </div>
      </a>

      <div class="stats-badge">
        <div class="stats-main"><span id="totalSeasons">5</span> Seasons ‚Ä¢ <span id="totalPlayers">58</span> Players</div>
        <div class="stats-sub">Icons: <span id="iconFormat">name.png</span></div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="header-nav" aria-label="Primary navigation">
      <ul class="nav-list">
        <li class="nav-item">
          <a href="index.html" class="nav-link" data-page="index">
            <span class="nav-icon">üè†</span>
            <span>Home</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="current-season.html" class="nav-link" data-page="current-season">
            <span class="nav-icon">üìä</span>
            <span>Current Season</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="voting-analytics.html" class="nav-link" data-page="voting-analytics">
            <span class="nav-icon">üßæ</span>
            <span>Voting Analytics</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="franchise.html" class="nav-link" data-page="franchise">
            <span class="nav-icon">üèõÔ∏è</span>
            <span>Franchise</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="rankings.html" class="nav-link" data-page="rankings">
            <span class="nav-icon">üèÜ</span>
            <span>Rankings</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="seasons.html" class="nav-link" data-page="seasons">
            <span class="nav-icon">üóÇÔ∏è</span>
            <span>Seasons</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="devotees.html" class="nav-link" data-page="devotees">
            <span class="nav-icon">üë•</span>
            <span>Players</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="awards.html" class="nav-link" data-page="awards">
            <span class="nav-icon">üèÖ</span>
            <span>Awards</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</header>

<script>
(function() {
  // Load site config and update header stats
  if (window.SITE_CONFIG) {
    document.getElementById('totalSeasons').textContent = window.SITE_CONFIG.seasons;
    document.getElementById('totalPlayers').textContent = window.SITE_CONFIG.players;
    document.getElementById('currentSeasonNum').textContent = window.SITE_CONFIG.currentSeason;
    document.getElementById('iconFormat').textContent = window.SITE_CONFIG.iconFormat;
  }

  // Scroll behavior
  const header = document.getElementById('modernHeader');
  if (!header) return;
  
  window.addEventListener('scroll', () => {
    const currentScroll = window.pageYOffset;
    if (currentScroll > 20) {
      header.classList.add('scrolled');
    } else {
      header.classList.remove('scrolled');
    }
  }, { passive: true });

  // Active page highlighting
  const currentPage = window.location.pathname.split('/').pop() || 'index.html';
  const navLinks = document.querySelectorAll('.nav-link');
  
  navLinks.forEach(link => {
    const linkPage = link.getAttribute('href');
    if (linkPage === currentPage || (currentPage === '' && linkPage === 'index.html')) {
      link.classList.add('active');
    }
  });

  // Path resolution for nested folders
  const root = (document.documentElement.dataset.root || document.body.dataset.root || ".").replace(/\/+$/, "");
  
  if (root !== ".") {
    const allLinks = header.querySelectorAll('a[href]');
    allLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (href && !href.startsWith('http') && !href.startsWith('#')) {
        link.setAttribute('href', root + '/' + href);
      }
    });
  }
})();
</script>
<!-- SITE HEADER END -->

<div class="container">
  <div class="topbar">
    <div>
      <div class="brand">DC <span>Franchise</span> Database</div>
      <div class="meta">Local static website ‚Ä¢ Click seasons + player profiles ‚Ä¢ Search + sort included</div>
    </div>
    <div class="meta">Season count: 5 ‚Ä¢ Player count: 58</div>
  </div>

  
  <!-- Loading state -->
  <div id="loading" style="text-align:center; padding:60px 0;">
    <p style="font-size:18px; color:#666;">Loading player data...</p>
  </div>
  
  <!-- Error state -->
  <div id="error" style="display:none; text-align:center; padding:60px 0;">
    <h2 style="color:#e53e3e;">Player Not Found</h2>
    <p style="color:#666; margin:20px 0;">The requested player could not be found.</p>
    <a class="tab" href="devotees.html">‚Üê Back to Players</a>
  </div>
  
  <!-- Player profile content -->
  <div id="player-content" style="display:none;">
    <!-- Content will be inserted here by JavaScript -->
  </div>

  <div class="footer">5 seasons complete ‚Ä¢ 58 unique players</div>
</div>

<!-- SITE FOOTER START -->
<footer class="siteFooter">
  <div class="footerInner">
    <div class="footerTitle">DC Franchise Database</div>
    <div class="footerSub">Static archive ‚Ä¢ 5 seasons ‚Ä¢ 58 players ‚Ä¢ Icons: name.png</div>
  </div>
</footer>
<!-- SITE FOOTER END -->

<script>
/* ============================================
   PLAYER STORY FORMATTER
   ============================================ */

// Replace the formatPlayerStory function in player.html with this fixed version:

function formatPlayerStory(storyText) {
  if (!storyText) {
    return '<p style="color: #94a3b8; text-align: center; padding: 40px;">No story available</p>';
  }
  
  // Check if story has season separators
  const hasSeparators = storyText.includes('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ') || storyText.match(/SEASON\s+\d+\s+[‚Äî\-‚Äì]/);
  
  // If no separators, render as simple formatted text
  if (!hasSeparators) {
    const paragraphs = storyText.split(/\n\n+/).filter(p => p.trim());
    
    const formattedParagraphs = paragraphs.map(p => {
      let formatted = p
        .replace(/(\d+)\s+(immunity wins?|challenge wins?|total wins?|votes?|idols?)/gi, 
          '<span class="stats-highlight">$1 $2</span>')
        .replace(/(Final Tribal Council?|merge|finale|endgame|jury|fire-making)/gi, 
          '<span class="stats-highlight">$1</span>')
        .replace(/(\d+)[‚Äì\-](\d+)(?:[‚Äì\-](\d+))?/g, 
          '<span class="stats-highlight">$&</span>');
      
      return '<p>' + formatted + '</p>';
    }).join('');
    
    return '<div class="season-body" style="border-left: none;">' + formattedParagraphs + '</div>';
  }
  
  // üÜï IMPROVED PARSING: Handle different story formats
  // First, try to extract all SEASON headers with their content
  const seasonPattern = /SEASON\s+(\d+)\s+[‚Äî\-‚Äì]\s+([^\n]+)/g;
  const seasonHeaders = [];
  let match;
  
  while ((match = seasonPattern.exec(storyText)) !== null) {
    seasonHeaders.push({
      index: match.index,
      seasonNum: match[1],
      seasonTheme: match[2].trim(),
      fullMatch: match[0]
    });
  }
  
  // If we found season headers, use them to split the content
  if (seasonHeaders.length > 0) {
    const seasonMap = new Map();
    
    for (let i = 0; i < seasonHeaders.length; i++) {
      const header = seasonHeaders[i];
      const nextHeader = seasonHeaders[i + 1];
      
      // Get content from after this header to before the next header (or end of string)
      const startPos = header.index + header.fullMatch.length;
      const endPos = nextHeader ? nextHeader.index : storyText.length;
      let content = storyText.substring(startPos, endPos);
      
      // Remove separator lines (‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ)
      content = content.replace(/‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ+/g, '').trim();
      
      // Skip if empty
      if (!content) continue;
      
      // If this season already exists, merge content
      if (seasonMap.has(header.seasonNum)) {
        const existing = seasonMap.get(header.seasonNum);
        existing.content += '\n\n' + content;
      } else {
        seasonMap.set(header.seasonNum, {
          seasonNum: header.seasonNum,
          seasonTheme: header.seasonTheme,
          content: content
        });
      }
    }
    
    // Handle content BEFORE the first season header (for returnees)
    if (seasonHeaders[0].index > 0) {
      const beforeContent = storyText.substring(0, seasonHeaders[0].index).trim();
      // Remove separators
      const cleanContent = beforeContent.replace(/‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ+/g, '').trim();
      
      if (cleanContent) {
        // Try to detect which season this is from context
        // Look for "Season X" mentions in the content
        const seasonMention = cleanContent.match(/(?:Season|S)\s*(\d+)/i);
        if (seasonMention) {
          const detectedSeason = seasonMention[1];
          // Try to get theme from the content itself or use "Unknown"
          const themeMatch = cleanContent.match(/(?:Season\s*\d+\s+[‚Äî\-‚Äì]\s+([^.,\n]+)|on\s+([^(,\n]+)\s*\(Season)/i);
          const theme = themeMatch ? (themeMatch[1] || themeMatch[2] || '').trim() : 'Previous Season';
          
          seasonMap.set(detectedSeason, {
            seasonNum: detectedSeason,
            seasonTheme: theme,
            content: cleanContent
          });
        }
      }
    }
    
    // Render seasons
    let html = '';
    const sortedSeasons = Array.from(seasonMap.entries()).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
    
    for (const [seasonNum, seasonData] of sortedSeasons) {
      const { seasonTheme, content } = seasonData;
      
      // Split into paragraphs
      const paragraphs = content.split(/\n\n+/).filter(p => p.trim());
      
      // Skip if no paragraphs
      if (paragraphs.length === 0) continue;
      
      // Extract result from last paragraph
      let resultBadge = '';
      const lastPara = paragraphs[paragraphs.length - 1];
      if (lastPara) {
        if (lastPara.includes('won Season') || lastPara.match(/Result:.*(?:win|champion|1st)/i)) {
          resultBadge = '<span class="result-badge result-winner">üèÜ Winner</span>';
        } else if (lastPara.match(/runner-up|2nd/i)) {
          resultBadge = '<span class="result-badge result-runnerup">ü•à Runner-Up</span>';
        } else if (lastPara.match(/eliminated|placed \d+th|finished \d+th|Final \d+/i)) {
          const placement = lastPara.match(/(\d+)(?:st|nd|rd|th)/);
          if (placement) {
            resultBadge = '<span class="result-badge result-eliminated">Eliminated ' + placement[0] + '</span>';
          }
        }
      }
      
      // Highlight stats
      const formattedParagraphs = paragraphs.map(p => {
        let formatted = p
          .replace(/(\d+)\s+(immunity wins?|challenge wins?|total wins?|votes?|idols?)/gi, 
            '<span class="stats-highlight">$1 $2</span>')
          .replace(/(Final Tribal Council?|merge|finale|endgame|jury|fire-making)/gi, 
            '<span class="stats-highlight">$1</span>')
          .replace(/(\d+)[‚Äì\-](\d+)(?:[‚Äì\-](\d+))?/g, 
            '<span class="stats-highlight">$&</span>');
        
        return '<p>' + formatted + '</p>';
      }).join('');
      
      html += '<div class="season-section">' +
        '<div class="season-header">' +
          '<div class="season-number">Season ' + seasonNum + '</div>' +
          '<div class="season-theme">' + seasonTheme + '</div>' +
        '</div>' +
        '<div class="season-body">' +
          formattedParagraphs +
          resultBadge +
        '</div>' +
      '</div>';
    }
    
    return html || '<p style="color: #94a3b8; text-align: center; padding: 40px;">Could not parse story</p>';
  }
  
  // Fallback: No season headers found, just render as formatted text
  const paragraphs = storyText.split(/\n\n+/).filter(p => p.trim());
  const formattedParagraphs = paragraphs.map(p => {
    let formatted = p
      .replace(/(\d+)\s+(immunity wins?|challenge wins?|total wins?|votes?|idols?)/gi, 
        '<span class="stats-highlight">$1 $2</span>')
      .replace(/(Final Tribal Council?|merge|finale|endgame|jury|fire-making)/gi, 
        '<span class="stats-highlight">$1</span>')
      .replace(/(\d+)[‚Äì\-](\d+)(?:[‚Äì\-](\d+))?/g, 
        '<span class="stats-highlight">$&</span>');
    
    return '<p>' + formatted + '</p>';
  }).join('');
  
  return '<div class="season-body" style="border-left: none;">' + formattedParagraphs + '</div>';
}

// Get player ID from URL parameter
const urlParams = new URLSearchParams(window.location.search);
const playerId = urlParams.get('player');

if (!playerId) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error').style.display = 'block';
} else {
  // Load player database with localStorage priority
  loadPlayerDatabase().then(data => {
    const player = data.players.find(p => p.id === playerId);
    
    if (!player) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      return;
    }
    
    // Update page title
    document.title = player.name + ' ‚Äì Profile';
    
    // Render player profile
    renderPlayerProfile(player);
    
    document.getElementById('loading').style.display = 'none';
    document.getElementById('player-content').style.display = 'block';
  }).catch(error => {
    console.error('Error loading player data:', error);
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
  });
}

// Load database: try localStorage first, then project file
async function loadPlayerDatabase() {
  try {
    // Try localStorage first
    const raw = localStorage.getItem("players_database");
    if (raw) {
      console.log("‚úÖ Loaded database from localStorage");
      return JSON.parse(raw);
    }
    
    // Fall back to project file
    console.log("‚ö†Ô∏è localStorage empty, loading from project file...");
    const response = await fetch('players_database.json');
    const data = await response.json();
    
    // Save to localStorage for next time
    localStorage.setItem("players_database", JSON.stringify(data, null, 2));
    console.log("‚úÖ Loaded from project file and saved to localStorage");
    
    return data;
  } catch (error) {
    console.error("‚ùå Error loading database:", error);
    throw error;
  }
}

function renderPlayerProfile(player) {
  const container = document.getElementById('player-content');
  
  // Sort seasons in reverse chronological order (most recent first)
  const sortedSeasons = player.seasonDetails.slice().sort((a, b) => b.season - a.season);
  const mostRecentSeason = sortedSeasons[0];
  const olderSeasons = sortedSeasons.slice(1);
  
  // Build season links
  const seasonLinks = player.seasons.map(function(s) {
  return '<a class="tab" href="season_ref.html?season=' + s + '">Season ' + s + '</a>';
  }).join('\n      ');
  
  // Find winner season if applicable
  let winnerSeasonNum = '';
  if (player.wins > 0) {
    const winnerSeason = player.seasonDetails.find(function(sd) {
      return sd.placement === 1;
    });
    if (winnerSeason) {
      winnerSeasonNum = winnerSeason.season;
    }
  }
  
  // Build badges HTML
  let badgesHtml = '';
  if (player.badges && player.badges.length > 0) {
    badgesHtml = '<div class="badges">';
    player.badges.forEach(function(badge) {
      let badgeClass = 'badge';
      if (badge.includes('WINNER') || badge.includes('Winner') || badge.includes('Runner-Up')) {
        badgeClass += ' gold';
      } else if (badge.includes('Strategic') || badge.includes('Social')) {
        badgeClass += ' purple';
      } else if (badge.includes('Unbreakable') || badge.includes('Perfect') || badge.includes('Placement')) {
        badgeClass += ' good';
      }
      badgesHtml += '<span class="' + badgeClass + '">' + badge + '</span>';
    });
    badgesHtml += '</div>';
  }
  
  // Build hero section
  let heroHtml = '<div class="hero" style="text-align:left">';
  heroHtml += '<div class="row" style="justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap">';
  heroHtml += '<div class="row" style="gap:14px">';
  heroHtml += '<div class="avatar" style="position:relative; overflow:hidden; width:80px; height:80px">';
  heroHtml += '<img src="assets/avatars/' + player.id + '.png" alt="" style="width:100%;height:100%;object-fit:cover" id="img-' + player.id + '"/>';
  heroHtml += '<span id="fallback-' + player.id + '" style="display:none">üë§</span>';
  heroHtml += '</div>';
  heroHtml += '<div>';
  heroHtml += '<h1 style="margin:0 0 6px">' + player.name + (player.wins > 0 ? ' üèÜ' : '') + '</h1>';
  heroHtml += '<div class="sub">Seasons: ' + player.seasons.join(', ') + ' ‚Ä¢ Best: #' + player.bestPlacement;
  if (player.wins > 0 && winnerSeasonNum) {
    heroHtml += ' (WINNER S' + winnerSeasonNum + '!)';
  }
  heroHtml += ' ‚Ä¢ Wins: ' + player.wins + '</div>';
  heroHtml += '<div class="small" style="margin-top:6px">';
  heroHtml += '<b>Avatar slot:</b> add image at <span class="tag">assets/avatars/' + player.id + '.png</span>';
  heroHtml += '</div></div></div>';
  heroHtml += '<div class="row" style="gap:10px">';
  heroHtml += '<a class="tab" href="devotees.html">‚Üê Devotees</a>';
  heroHtml += seasonLinks;
  heroHtml += '</div></div></div>';

  // Career Summary
  heroHtml += '<div class="section-title"><h2>Career Summary</h2>';
  heroHtml += '<div class="hint">' + player.totalSeasons + ' season' + (player.totalSeasons > 1 ? 's' : '') + '</div></div>';
  
  heroHtml += '<div class="statsbar">';
  heroHtml += '<div class="stat"><div class="num">' + player.totalSeasons + '</div><div class="label">Seasons</div></div>';
  heroHtml += '<div class="stat"><div class="num">' + player.wins + '</div><div class="label">Wins</div></div>';
  heroHtml += '<div class="stat"><div class="num">#' + player.bestPlacement + '</div><div class="label">Best Place</div></div>';
  heroHtml += '<div class="stat"><div class="num">' + player.totalChallengeWins + '</div><div class="label">Challenge Wins</div></div>';
  heroHtml += '</div>';
  
  heroHtml += badgesHtml;

  // Most Recent Season
  const seasonTitle = getSeasonTitle(mostRecentSeason.season);
  heroHtml += '<div class="section-title" style="margin-top:26px">';
  heroHtml += '<h2>üî• Season ' + mostRecentSeason.season + seasonTitle + '</h2>';
  heroHtml += '<div class="hint">Most Recent</div></div>';
  heroHtml += renderSeasonDetails(mostRecentSeason, true);

  // Older Seasons
  olderSeasons.forEach(function(season) {
    const title = getSeasonTitle(season.season);
    heroHtml += '<div class="section-title" style="margin-top:26px">';
    heroHtml += '<h2>üìä Season ' + season.season + title + '</h2></div>';
    heroHtml += renderSeasonDetails(season, false);
  });

  // Player Story
  if (player.story) {
    heroHtml += '<div class="section-title" style="margin-top:26px"><h2>üìñ Player Story</h2></div>';
    heroHtml += '<div class="player-story-container">' + formatPlayerStory(player.story) + '</div>';
  }

  // Career Totals
  heroHtml += '<div class="section-title" style="margin-top:26px"><h2>Career Totals</h2></div>';
  heroHtml += '<div class="statsbar">';
  heroHtml += '<div class="stat"><div class="num">' + player.totalVotesAgainst + '</div><div class="label">Total Votes Against</div></div>';
  heroHtml += '<div class="stat"><div class="num">' + player.totalChallengeWins + '</div><div class="label">Total Challenge Wins</div></div>';
  heroHtml += '<div class="stat"><div class="num">' + player.totalImmunityWins + '</div><div class="label">Total Immunity Wins</div></div>';
  
  if (player.totalJuryVotes !== undefined) {
    heroHtml += '<div class="stat"><div class="num">' + player.totalJuryVotes + '</div><div class="label">Total Jury Votes</div></div>';
  } else {
    heroHtml += '<div class="stat"><div class="num">' + (player.totalIdolsFound || 0) + '</div><div class="label">Total Idols Found</div></div>';
  }
  heroHtml += '</div>';

  // Add avatar fallback script
  heroHtml += '<script>';
  heroHtml += 'const img = document.getElementById("img-' + player.id + '");';
  heroHtml += 'const fb = document.getElementById("fallback-' + player.id + '");';
  heroHtml += 'if(img) {';
  heroHtml += '  img.onload = function() { img.style.display="block"; if(fb) fb.style.display="none"; };';
  heroHtml += '  img.onerror = function() { img.style.display="none"; if(fb) fb.style.display="block"; };';
  heroHtml += '}';
  heroHtml += '<\/script>';

  container.innerHTML = heroHtml;
}

function getSeasonTitle(seasonNum) {
  const titles = {
    1: ' ‚Äì Total Drama: Cullhouse',
    2: ' ‚Äì Total Drama 2',
    3: ' ‚Äì Revenge of the Island',
    4: ' ‚Äì Edge of Extinction',
    5: ' ‚Äì Season 5'
  };
  return titles[seasonNum] || '';
}

// Replace the renderSeasonDetails function in your player.html with this updated version:

function renderSeasonDetails(season, isMostRecent) {
  let html = '<div class="kpi-grid">\n  <div class="kpi">\n    <h3>Placement</h3>\n    <ul>\n';
  
  html += '      <li><b>Rank:</b> #' + season.placement;
  if (season.placement === 1) html += ' (WINNER! üëë)';
  else if (season.placement === 2) html += ' (Runner-up)';
  html += '</li>\n';
  
  if (season.status) html += '      <li><b>Status:</b> ' + season.status + '</li>\n';
  if (season.tribe) html += '      <li><b>Tribe:</b> ' + season.tribe + '</li>\n';
  if (season.finalVote) html += '      <li><b>Final Vote:</b> ' + season.finalVote + '</li>\n';
  if (season.juryVotes !== undefined) html += '      <li><b>Jury votes:</b> ' + season.juryVotes + '</li>\n';
  
  html += '    </ul>\n  </div>\n';
  
  // Performance
  html += '  <div class="kpi">\n    <h3>Performance</h3>\n    <ul>\n';
  html += '      <li><b>Challenge wins:</b> ' + season.challengeWins + '</li>\n';
  html += '      <li><b>Immunity wins:</b> ' + season.immunityWins + '</li>\n';
  if (season.rewardWins !== undefined) html += '      <li><b>Reward wins:</b> ' + season.rewardWins + '</li>\n';
  if (season.strategicRank) html += '      <li><b>Strategic rank:</b> ' + season.strategicRank + '</li>\n';
  
  // üÜï ADD GAMEPLAY STYLE if present
  if (season.gameplayStyle) {
    html += '      <li><b>Gameplay Style:</b> ' + season.gameplayStyle + '</li>\n';
  }
  
  html += '    </ul>\n  </div>\n';
  
  // Advantages & Threat
  html += '  <div class="kpi">\n    <h3>Advantages & Threat</h3>\n    <ul>\n';
  html += '      <li><b>Votes received:</b> ' + season.votesReceived + '</li>\n';
  if (season.idolsFound !== undefined) html += '      <li><b>Idols found:</b> ' + season.idolsFound + '</li>\n';
  if (season.advantages && season.advantages.length > 0) {
    season.advantages.forEach(function(adv) {
      html += '      <li><b>Advantage:</b> ' + adv + '</li>\n';
    });
  }
  if (isMostRecent && season.strategicRank) html += '      <li><b>Strategic rank:</b> ' + season.strategicRank + '</li>\n';
  html += '    </ul>\n  </div>\n';
  
  // üÜï KEY MOMENTS (only if present and not empty)
  if (season.keyMoments && season.keyMoments.length > 0) {
    html += '  <div class="kpi">\n    <h3>üîë Key Moments</h3>\n    <ul>\n';
    season.keyMoments.forEach(function(moment) {
      html += '      <li>' + moment + '</li>\n';
    });
    html += '    </ul>\n  </div>\n';
  }
  
  // üÜï ALLIANCES (only if present and not empty)
  if (season.alliances && season.alliances.length > 0) {
    html += '  <div class="kpi">\n    <h3>ü§ù Key Alliances</h3>\n    <ul>\n';
    season.alliances.forEach(function(ally) {
      html += '      <li>' + ally + '</li>\n';
    });
    html += '    </ul>\n  </div>\n';
  }
  
  // üÜï RIVALRIES (only if present and not empty)
  if (season.rivalries && season.rivalries.length > 0) {
    html += '  <div class="kpi">\n    <h3>‚öîÔ∏è Rivalries</h3>\n    <ul>\n';
    season.rivalries.forEach(function(rival) {
      html += '      <li>' + rival + '</li>\n';
    });
    html += '    </ul>\n  </div>\n';
  }
  
  // Notes (original)
  if (season.notes && season.notes.length > 0) {
    html += '  <div class="kpi">\n    <h3>Notes</h3>\n    <ul>\n';
    season.notes.forEach(function(note) {
      html += '      <li>' + note + '</li>\n';
    });
    html += '    </ul>\n  </div>\n';
  }
  
  html += '</div>\n';
  
  return html;
}
</script>

</body>
</html>
